# Phase 4 — Architecture & Ecosystem Design

**Date:** 2026-02-24
**Target version:** 2.0.0

---

## Goal

Three independent improvements that lift the library to a production-grade npm package:

1. **ESM/CJS/UMD build** — add a `tsup` build step that produces `dist/` for bundler consumers while keeping `lib/` intact for CDN users.
2. **TypeScript declarations** — hand-author `lib/pardis-jalali-datepicker.d.ts` covering the full public API; `tsup` copies it to `dist/index.d.ts`.
3. **`aria-labelledby` fix** — wire the `role="dialog"` popover to the rendered month+year heading via an instance-scoped ID.

---

## Section A — ESM/CJS/UMD Build

### Decisions

- `lib/pardis-jalali-datepicker.js` stays **unchanged** as the CDN/vanilla UMD file.
- `dist/` is the **new npm entry**, generated by `tsup` from `lib/`.
- A CJS-compatible export guard is appended to `lib/pardis-jalali-datepicker.js` so Node `require()` and bundlers can import it:

  ```js
  if (typeof module !== 'undefined') {
    module.exports = { PardisDatepicker, PardisEngine, JalaaliUtil };
  }
  ```

  This guard is invisible to browser `<script>` usage (where `module` is undefined).

### Build output

| File | Format | Exported global |
|---|---|---|
| `dist/index.mjs` | ESM | — |
| `dist/index.cjs` | CJS | — |
| `dist/index.global.js` | IIFE | `window.PardisJalaliDatepicker` |
| `dist/index.d.ts` | Types | — |

### `tsup.config.js` (root)

```js
import { defineConfig } from 'tsup';
export default defineConfig({
  entry: ['lib/pardis-jalali-datepicker.js'],
  format: ['esm', 'cjs', 'iife'],
  globalName: 'PardisJalaliDatepicker',
  dts: { only: false },
  outDir: 'dist',
  clean: true,
  minify: false,
  splitting: false,
  sourcemap: false,
});
```

### `package.json` additions

```json
"main":    "./dist/index.cjs",
"module":  "./dist/index.mjs",
"types":   "./dist/index.d.ts",
"exports": {
  ".": {
    "import":  "./dist/index.mjs",
    "require": "./dist/index.cjs",
    "types":   "./dist/index.d.ts"
  }
},
"files": ["lib", "dist", "README.md", "LICENSE"],
"sideEffects": ["**/*.css"],
"engines": { "node": ">=16.0.0" },
"scripts": {
  "build": "tsup",
  "test":  "node scripts/year-boundary-test.js"
},
"devDependencies": {
  "tsup": "^8.0.0"
}
```

---

## Section B — TypeScript Declaration File

**File:** `lib/pardis-jalali-datepicker.d.ts` (hand-authored; copied to `dist/index.d.ts` by tsup via `dts` option or explicit copy step)

```ts
export interface JalaliDate {
  jy: number;
  jm: number;
  jd: number;
}

export interface DateRange {
  start: JalaliDate | null;
  end: JalaliDate | null;
}

export interface PardisOptions {
  inline?: boolean;
  rangeMode?: boolean;
  outputFormat?: 'jalali' | 'gregorian' | 'both';
  mobileMode?: boolean;
  minDate?: JalaliDate | null;
  maxDate?: JalaliDate | null;
  initialYear?: number | null;
  initialMonth?: number | null;
  disabledDates?: JalaliDate[] | ((jy: number, jm: number, jd: number) => boolean) | null;
  highlightedDates?: (JalaliDate & { className?: string })[] | null;
  maxRange?: number | null;
  numeralType?: 'persian' | 'latin';
  onChange?: ((payload: object) => void) | null;
  onRangeStart?: ((payload: object) => void) | null;
  onRangeSelect?: ((range: DateRange) => void) | null;
  onClear?: (() => void) | null;
}

export declare class PardisDatepicker {
  constructor(target: string | HTMLElement, options?: PardisOptions);
  getValue(): object | null;
  setValue(date: JalaliDate): void;
  setOption(key: keyof PardisOptions, value: unknown): void;
  open(): void;
  close(): void;
  destroy(): void;
  goToToday(): void;
  getPresetRange(name: 'thisWeek' | 'thisMonth' | 'last7Days' | 'last30Days'): DateRange;
}
```

`tsup` cannot auto-generate `.d.ts` from plain JS source, so the build script copies this file:

```json
"build": "tsup && cp lib/pardis-jalali-datepicker.d.ts dist/index.d.ts"
```

---

## Section C — `aria-labelledby` Fix

### Problem

`this._popover` has `role="dialog"` and `aria-modal="true"` but no `aria-labelledby`, so screen readers cannot announce what the dialog is.
It also has a redundant `aria-label="تقویم تاریخ"` that should be removed once `aria-labelledby` is wired.

### Three touch points

**1. Instance counter + heading ID (constructor)**

```js
// At class level (after the class definition)
PardisDatepicker._counter = 0;

// In constructor, after this._isOpen = false:
this._headingId = 'pardis-heading-' + (++PardisDatepicker._counter);
```

**2. Popover wiring (~line 1182)**

```js
this._popover.setAttribute('role', 'dialog');
this._popover.setAttribute('aria-modal', 'true');
// Remove aria-label; replace with aria-labelledby:
this._popover.setAttribute('aria-labelledby', this._headingId);
```

**3. Renderer heading ID**

`PardisRenderer` constructor signature: `constructor(containerEl, engine, options = {})`.
Pass `headingId` via options:

```js
// In PardisDatepicker._buildUI():
this._renderer = new PardisRenderer(this._calEl, this.engine, { headingId: this._headingId });
```

In `PardisRenderer._renderDayView()`, the `.pardis-header-title` div is built as an HTML string.
Change it to set an `id` on the wrapping div:

```js
// Before (line ~712):
<div class="pardis-header-title">

// After:
<div class="pardis-header-title" id="${this.options.headingId || ''}">
```

Same change applied to `_renderMonthView()` and `_renderYearView()` heading divs so the ID is always present regardless of view mode.

---

## Version bump

This is a **major version** (2.0.0) because:
- `package.json` `"main"` moves from `lib/` to `dist/` — bundler consumers' import paths change.
- The `"exports"` field blocks deep imports that might have been used.
- CDN/vanilla users are **unaffected** (lib/ stays).

---

## Verification checklist

- [ ] `npm install` (installs tsup devDep)
- [ ] `npm run build` produces `dist/index.mjs`, `dist/index.cjs`, `dist/index.global.js`, `dist/index.d.ts`
- [ ] `npm test` still passes
- [ ] `require('pardis-jalali-datepicker')` in Node resolves to `dist/index.cjs`
- [ ] TypeScript: `import { PardisDatepicker, PardisOptions } from 'pardis-jalali-datepicker'` compiles without errors under `strict: true`
- [ ] `dist/index.d.ts` contains all interfaces and class declaration
- [ ] Screen reader announces month+year when dialog opens
- [ ] Two simultaneous instances have different `pardis-heading-1` / `pardis-heading-2` IDs
- [ ] Inline mode: heading ID is also set (same code path)
- [ ] `aria-label="تقویم تاریخ"` removed from popover (replaced by `aria-labelledby`)
- [ ] CDN `<script src="lib/pardis-jalali-datepicker.js">` still works unchanged
